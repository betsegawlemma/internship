\chapter{Implementing flow-level model}
\label{chapter:implementation}

In this chapter we start by describing how we started the implementation task, we then move to the discussion of the implementation details together with the challenges we encountered. Finally, we present the final version of the implemented flow-level model. 
\subsection{The starting flow-level model}

By definition, as we have shown in Equation~\ref{eq:2.1}, the energy consumption of a given electronic equipment is given by the product of the average power drawn by the equipment and its time duration of running. We have also shown, in Figure~\ref{fig:energyproportionality} and Equation~\ref{eq:2.2}, the linear relationship that exist between network equipment load and power consumption. Combining Equation~\ref{eq:2.1} and Equation~\ref{eq:2.2}, we get the following equation for energy consumption for a given time duration of T, where \($$P_{idle}$$\) is the power that the equipment consumed when there is no traffic and \(P_{dynamic (avg)}\) is the average power drawn during the time interval T in the presence of network traffic.

\begin{equation} \label{eq:5.1}
E(T) = (P_{idle} + P_{dynamic (avg)}) * T 
\end{equation} 

To implement this model in SimGrid, we need to determine the values of the three variables shown in Equation~\ref{eq:5.1}. We can directly read the idle power consumption value from the SimGrid's link property that we described in Section~\ref{section:simgridenvironment}. For the other two, we need to understand how SimGrid compute load and time in its core. 

Briefly described, for a set of simulated activities running on a given simulated resource such as a switch, SimGrid computes using its MAX-MIN algorithm the amount of resource that each activity can get. At a given moment the sum of the resources that are assigned to all activities running on the resource cannot exceed the capacity of the resource. Figure~\ref{fig:SimGrid} depicts this concept symbolically and we access how much of the resource is currently in use, i.e., its load. 

In our case, the load is the total amount of bandwidth that is assigned to all data transfer activities running on a given Link and we can get the maximum bandwidth capacity of the Link from its description on the platform file. With these two information and with the busy power consumption value of the link, we can compute the dynamic power consumption part of the Link at a given instant, \(P_{dynamic (avg)}\), as shown in Equation~\ref{eq:5.2}:

\begin{equation} \label{eq:5.2}
P_{dynamic} = (P_{busy} - P_{idle}) * u 
\end{equation} 
where:
\begin{description}
    \item [u]: is a normalized utilization factor obtained by dividing the current Link load with its capacity and 
    \item [(\($$P_{busy} - P_{idle}$$\))]: is the slope of the load vs power consumption relationship graph as shown in Figure~\ref{fig:energyproportionality}.
\end{description} 

Now we are left with computing the time, T, variable of Equation~\ref{eq:5.1}. We can get this value from SimGrid, we can read the current time value, for example, when a given data transfer completes and then use that value to compute the energy consume to transfer the data.

We implemented this model and designed a simple simulation experiment with two nodes connected by a single link. The link has a fixed bandwidth (1 GBytes) and a fixed latency (10 ms). We then run this experiment in both SimGrid and ECOFEN module of NS-3 40 times with randomly generated data size values between 1 and 1000 MBytes. From the simulation output we have realized that there is a significant difference between ECOFEN's and SimGrid's output in terms of the simulated time required to transfer a given size of data. 

The approach we followed to resolve this issue is to obtain an equation which relate data transfer time with data size. Sine we are using ECOFEN module of NS-3 (a packet-level simulator) as a ground truth, we used ECOFEN's time output for transferring a given data size in order to estimate the parameters, \($$\beta_1$$\) and \($$\beta_2$$\) of data transfer time, \($$T_{data}$$\), in Equation~\ref{eq:5.3}. 
\begin{equation} \label{eq:5.3}
T_{data} = \beta_1 * data\_size + \beta_2
\end{equation} 

